## 条款06：若不想使用编译器自动生成的函数，就该明确拒绝

**Explicitly disallow the use of compiler-generated functions you do not want**

从上一个条款中，我们知道，如果我们不声明，编译器可能会为我们的类（如 `HomeForSale`）自动生成公有的拷贝构造函数和拷贝赋值运算符。但是对于 `HomeForSale`（待售房屋）这样的类，拷贝操作在逻辑上是荒谬的。每个房屋都是独一无二的，我们不应该允许一个房屋对象被复制成另一个。我们希望任何尝试拷贝 `HomeForSale` 对象的代码（如 `HomeForSale h2(h1);` 或 `h1 = h2;`）在编译时就失败。

文中给出了两种方法来禁止类的拷贝操作：

方案一：在 `private` 中声明 (但不定义)：

```cpp
class HomeForSale {
public:
    // ...
private:
    // 将拷贝函数声明为 private
    HomeForSale(const HomeForSale&);
    HomeForSale& operator=(const HomeForSale&);
};
```

原理：

- 阻止编译器生成：由于我们声明了这些函数，编译器就不会再自动生成它自己的 `public` 默认版本了。
- 阻止外部调用：当类外部的代码尝试拷贝对象时：`HomeForSale h2(h1);` 编译器会报错，因为它试图访问一个 `private` 成员。这就在编译期阻止了外部拷贝。
- 阻止内部和友元调用:
  - `HomeForSale` 自己的成员函数或友元理论上可以访问 `private` 成员。
  - 但是，我们只声明了这两个函数，并没有去定义它们。
  - 如果成员函数或友元函数真的尝试调用它们，代码在编译时会通过，但在链接时会失败，因为链接器找不到这两个函数的定义。

方案二：使用 `Uncopyable` 基类：

方案一的缺点是，必须在每一个不想被拷贝的类里都重复写那两行 `private` 声明。这很繁琐。一个更高级、更可复用的方法是创建一个专门用于此目的的基类，这个模式在 Boost 库中很有名，叫 `boost::noncopyable`：

```cpp
// 一个专门用来“禁止拷贝”的基类
class Uncopyable {
protected:
    Uncopyable() {}    // 允许派生类构造
    ~Uncopyable() {}   // 允许派生类析构
private:
    // 明确禁止拷贝
    Uncopyable(const Uncopyable&);
    Uncopyable& operator=(const Uncopyable&);
};
```

然后，让 `HomeForSale` 私有地继承它：

```cpp
class HomeForSale : private Uncopyable {
    // ... HomeForSale 的其他成员 ...
    // 不再需要手动声明拷贝函数
};
```

原理：

- 当尝试拷贝 `HomeForSale` 对象时，编译器会尝试为 `HomeForSale` 生成一个默认的拷贝构造函数。
- 这个自动生成的 `HomeForSale` 拷贝构造函数，在拷贝它自己成员之前，必须首先调用其基类 `Uncopyable` 的拷贝构造函数。
- 但是，`Uncopyable` 的拷贝构造函数是 `private` 的。
- 因此，编译器在尝试为 `HomeForSale` 生成拷贝构造函数时，发现它自己无法访问基类的 `private` 函数，于是直接在编译期报错。

这个方法更干净，意图更明显，并且在编译期就能（在所有情况下）捕获错误，是 C++98 中禁止拷贝的最佳实践。

C++11 引入了 `delete` 关键字，使得禁止拷贝操作变得更加简单和直观。我们可以直接在类中使用 `delete` 来显式地禁止拷贝构造函数和拷贝赋值运算符：

```cpp
class HomeForSale {
public:
    // ...
    
    // C++11: 明确、公开地“删除”拷贝操作
    HomeForSale(const HomeForSale&) = delete;
    HomeForSale& operator=(const HomeForSale&) = delete;

    // 这也适用于 C++11 的移动操作
    HomeForSale(HomeForSale&&) = delete;
    HomeForSale& operator=(HomeForSale&&) = delete;
};
```